from io import StringIO

import pandas as pd
import pytest

s_mass = """
sample,mass,radius,length,density,element,mass_percent,mass_frac
sample_0,0.3,0.65,0.15,1.5067923606333287,H,0.75,0.0075
sample_0,0.3,0.65,0.15,1.5067923606333287,C,2.0,0.02
sample_0,0.3,0.65,0.15,1.5067923606333287,N,1.0,0.01
sample_0,0.3,0.65,0.15,1.5067923606333287,O,47.0,0.47
sample_0,0.3,0.65,0.15,1.5067923606333287,Na,1.22,0.012199999999999999
sample_0,0.3,0.65,0.15,1.5067923606333287,Mg,1.46,0.0146
sample_0,0.3,0.65,0.15,1.5067923606333287,Al,7.37,0.0737
sample_0,0.3,0.65,0.15,1.5067923606333287,Si,3.0,0.03
sample_0,0.3,0.65,0.15,1.5067923606333287,P,0.07,0.0007000000000000001
sample_0,0.3,0.65,0.15,1.5067923606333287,Ar,0.2,0.002
sample_0,0.3,0.65,0.15,1.5067923606333287,K,2.11,0.021099999999999997
sample_0,0.3,0.65,0.15,1.5067923606333287,Ca,30.0,0.3
sample_0,0.3,0.65,0.15,1.5067923606333287,Ti,0.336,0.00336
sample_0,0.3,0.65,0.15,1.5067923606333287,Fe,3.36,0.0336
sample_1,0.4,0.65,0.15,2.009056480844438,H,0.75,0.0075
sample_1,0.4,0.65,0.15,2.009056480844438,C,2.0,0.02
sample_1,0.4,0.65,0.15,2.009056480844438,N,1.0,0.01
sample_1,0.4,0.65,0.15,2.009056480844438,O,47.0,0.47
sample_1,0.4,0.65,0.15,2.009056480844438,Na,1.22,0.012199999999999999
sample_1,0.4,0.65,0.15,2.009056480844438,Mg,1.46,0.0146
sample_1,0.4,0.65,0.15,2.009056480844438,Al,7.37,0.0737
sample_1,0.4,0.65,0.15,2.009056480844438,Si,3.0,0.03
sample_1,0.4,0.65,0.15,2.009056480844438,P,0.07,0.0007000000000000001
sample_1,0.4,0.65,0.15,2.009056480844438,Ar,0.2,0.002
sample_1,0.4,0.65,0.15,2.009056480844438,K,2.11,0.021099999999999997
sample_1,0.4,0.65,0.15,2.009056480844438,Ca,30.0,0.3
sample_1,0.4,0.65,0.15,2.009056480844438,Ti,0.336,0.00336
sample_1,0.4,0.65,0.15,2.009056480844438,Fe,3.36,0.0336
sample_2,0.3,0.65,0.15,1.5067923606333287,H,1.0,0.01
sample_2,0.3,0.65,0.15,1.5067923606333287,C,2.0,0.02
sample_2,0.3,0.65,0.15,1.5067923606333287,N,1.0,0.01
sample_2,0.3,0.65,0.15,1.5067923606333287,O,47.0,0.47
sample_2,0.3,0.65,0.15,1.5067923606333287,Na,1.22,0.012199999999999999
sample_2,0.3,0.65,0.15,1.5067923606333287,Mg,1.46,0.0146
sample_2,0.3,0.65,0.15,1.5067923606333287,Al,7.37,0.0737
sample_2,0.3,0.65,0.15,1.5067923606333287,Si,3.0,0.03
sample_2,0.3,0.65,0.15,1.5067923606333287,P,0.07,0.0007000000000000001
sample_2,0.3,0.65,0.15,1.5067923606333287,Ar,0.2,0.002
sample_2,0.3,0.65,0.15,1.5067923606333287,K,2.11,0.021099999999999997
sample_2,0.3,0.65,0.15,1.5067923606333287,Ca,30.0,0.3
sample_2,0.3,0.65,0.15,1.5067923606333287,Ti,0.336,0.00336
sample_2,0.3,0.65,0.15,1.5067923606333287,Fe,3.36,0.0336
"""

s_ratio = """
,,,,,values,values,sample_0/sample,sample_0/sample,uncert,uncert
,,,,,f_scatter,f0_noscatter,f_scatter,f0_noscatter,f_scatter,f0_noscatter
sample,mass,radius,length,density,,,,,,
sample_0,0.3,0.65,0.15,1.5067923606333287,0.9977306051161332,0.9958168360313382,1.0,1.0,0.0,0.0
sample_1,0.4,0.65,0.15,2.009056480844438,0.9971138357174368,0.9946185064665436,1.0006185546490312,1.00120481325956,0.00012589752631410905,0.00024460799811984983
sample_2,0.3,0.65,0.15,1.5067923606333287,0.9976533767929456,0.9955508457237608,1.0000774099752319,1.0002671790282935,1.5764165458358606e-05,5.4295044174204355e-05

"""


def get_df_mass():
    with StringIO(s_mass) as f:
        df_mass = pd.read_csv(f, index_col=list(range(0, 6)))

    return df_mass


def get_df_ratio():
    with StringIO(s_ratio) as f:
        df_ratio = pd.read_csv(f, index_col=list(range(0, 5)), header=[0, 1])
    return df_ratio


import neutron_analysis.shielding as shielding


def test_shielding():

    df_mass = get_df_mass()
    df_ratio = get_df_ratio()

    S = shielding.NeutronShieldingUser(df_mass)
    S0 = shielding.NeutronShieldingUser(df_mass)

    for s in [S, S0]:

        pd.testing.assert_frame_equal(
            s.shielding_ratio("sample_0", value_name="values"), df_ratio
        )
