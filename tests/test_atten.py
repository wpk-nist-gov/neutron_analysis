from io import StringIO

import pandas as pd
import pytest

s_mass = """
sample,mass,radius,length,density,element,mass_frac,track
std,0.10707407371607613,0.65,0.15,0.5377946543242447,As,4.283715682920447e-05,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Cd,4.888071945425786e-05,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,W,3.5048011360010176e-05,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Au,9.131046049060264e-06,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Sm,6.7767795527705954e-06,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Lu,1.0534318534812894e-05,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,La,8.15185149320727e-06,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Mo,0.0002650862672008226,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Zn,0.00026535265296503323,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,C,0.4441525231038234,x
std,0.10707407371607613,0.65,0.15,0.5377946543242447,H,0.06211699778637823,x
std,0.10707407371607613,0.65,0.15,0.5377946543242447,O,0.49303868030635917,x
sample,0.32,0.65,0.15,1.6072451846755507,Si,0.34,x
sample,0.32,0.65,0.15,1.6072451846755507,Na,0.02,x
sample,0.32,0.65,0.15,1.6072451846755507,Ca,0.3,x
sample,0.32,0.65,0.15,1.6072451846755507,Mg,0.02,x
sample,0.32,0.65,0.15,1.6072451846755507,Al,0.07,x
sample,0.32,0.65,0.15,1.6072451846755507,K,0.02,
sample,0.32,0.65,0.15,1.6072451846755507,S,0.01,
sample,0.32,0.65,0.15,1.6072451846755507,Fe,0.006999999999999999,
sample,0.32,0.65,0.15,1.6072451846755507,Ti,0.01,
sample,0.32,0.65,0.15,1.6072451846755507,N,0.01,
sample,0.32,0.65,0.15,1.6072451846755507,O,0.47,x
sample,0.32,0.65,0.15,1.6072451846755507,C,0.005,
sample,0.32,0.65,0.15,1.6072451846755507,Ar,0.001,
sample,0.32,0.65,0.15,1.6072451846755507,H,0.0075,
QC,0.3,0.65,0.15,1.5067923606333287,P,0.000688,
QC,0.3,0.65,0.15,1.5067923606333287,Ar,0.002,
QC,0.3,0.65,0.15,1.5067923606333287,Ti,0.00336,
QC,0.3,0.65,0.15,1.5067923606333287,Mg,0.0146,
QC,0.3,0.65,0.15,1.5067923606333287,H,0.0075,x
QC,0.3,0.65,0.15,1.5067923606333287,Na,0.012199999999999999,x
QC,0.3,0.65,0.15,1.5067923606333287,Ca,0.0191,x
QC,0.3,0.65,0.15,1.5067923606333287,C,0.02,x
QC,0.3,0.65,0.15,1.5067923606333287,K,0.021099999999999997,x
QC,0.3,0.65,0.15,1.5067923606333287,Fe,0.0336,x
QC,0.3,0.65,0.15,1.5067923606333287,Al,0.0737,x
QC,0.3,0.65,0.15,1.5067923606333287,N,0.01,x
QC,0.3,0.65,0.15,1.5067923606333287,O,0.47,x
QC,0.3,0.65,0.15,1.5067923606333287,Si,0.303,x
"""

s_gamma = """
element,element_tot,gamma_kev,gamma_mev_used,energy
Mg,Mg-27,843.0,0.843,0.843
Al,Al-28,1778.8,1.778,1.7788
Ca,Ca-49,3084.5,3.084,3.0845
Cl,Cl-38,1642.59,1.643,1.64259
Mn,Mn-56,1810.7,1.817,1.8107
Na,Na-24,1368.55,1.36855,1.36855
Ti,Ti-51,320.0,0.32008,0.32
V,V-52,1434.0,1.434,1.434
Sc,Sc-46,889.6,0.8896,0.8896000000000001
Tb,Tb-160,879.8,0.8798,0.8797999999999999
Sr,Sr-85,514.5,0.5145,0.5145
Co,Co-60,1332.6,1.3326,1.3326
Eu,Eu-152,1408.0,1.408,1.408
Rb,Rb-86,1077.2,1.0772,1.0772
Ba,Ba-131,496.26,0.49626,0.49626
Cs,Cs-134,796.2,0.7962,0.7962
"""

s_shielding_ratio = """
,,,,,values,values,std/sample,std/sample,uncert,uncert
,,,,,f_scatter,f0_noscatter,f_scatter,f0_noscatter,f_scatter,f0_noscatter
sample,mass,radius,length,density,,,,,,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,0.9986338947598542,0.9969690868084721,1.0,1.0,0.0,0.0
sample,0.32,0.65,0.15,1.6072451846755507,0.9972433607245004,0.9949779466584113,1.0013943778320507,1.0020011902341635,0.00028384157138250897,0.00040643978116812924
QC,0.3,0.65,0.15,1.5067923606333287,0.9980006912125915,0.9962586347315935,1.0006344720528133,1.0007131201197268,0.00012925213284282686,0.0001450204229210921
"""

s_atten_ratio = """
,,,,,,,values,std/sample,uncert
,,,,,,,self_atten_coef,self_atten_coef,self_atten_coef
sample,mass,radius,length,density,element,energy,,,
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Mg,0.843,0.9970407561328006,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Al,1.7788,0.9979603981087514,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Ca,3.0845,0.9984921583758402,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Cl,1.64259,0.9978750485244645,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Mn,1.8107,0.9979803881491809,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Na,1.36855,0.9976708843212041,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Ti,0.32,0.995538738356402,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,V,1.434,0.9977280555547218,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Sc,0.8896000000000001,0.9971117957125745,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Tb,0.8797999999999999,0.997096855497794,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Sr,0.5145,0.9963170038141316,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Co,1.3326,0.9976394834937468,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Eu,1.408,0.997705343769972,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Rb,1.0772,0.9973688037034297,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Ba,0.49626,0.996263088537557,1.0,0.0
std,0.10707407371607613,0.65,0.15,0.5377946543242447,Cs,0.7962,0.9969672556709652,1.0,0.0
sample,0.32,0.65,0.15,1.6072451846755507,Mg,0.843,0.9892651992123584,1.007859931721679,0.001604401844269066
sample,0.32,0.65,0.15,1.6072451846755507,Al,1.7788,0.992565004913319,1.0054358084042099,0.0011095797441538903
sample,0.32,0.65,0.15,1.6072451846755507,Ca,3.0845,0.9943608616230237,1.0041547258266714,0.0008480798580423345
sample,0.32,0.65,0.15,1.6072451846755507,Cl,1.64259,0.9922677680218592,1.005650975153394,0.0011535004729134265
sample,0.32,0.65,0.15,1.6072451846755507,Mn,1.8107,0.9926346341382518,1.0053854195965768,0.0010992941718665308
sample,0.32,0.65,0.15,1.6072451846755507,Na,1.36855,0.9915458733974586,1.0061772340423933,0.0012609226188011302
sample,0.32,0.65,0.15,1.6072451846755507,Ti,0.32,0.9836387882940779,1.0120978861386325,0.002469470667161591
sample,0.32,0.65,0.15,1.6072451846755507,V,1.434,0.9917504167576338,1.006027362021819,0.0012303301207072042
sample,0.32,0.65,0.15,1.6072451846755507,Sc,0.8896000000000001,0.9895236391538149,1.0076684944740164,0.0015653248797243896
sample,0.32,0.65,0.15,1.6072451846755507,Tb,0.8797999999999999,0.9894692816354632,1.0077087525645299,0.0015735425280391162
sample,0.32,0.65,0.15,1.6072451846755507,Sr,0.5145,0.9866122870727403,1.0098364036902328,0.0020078474954249776
sample,0.32,0.65,0.15,1.6072451846755507,Co,1.3326,0.9914335469619433,1.006259558747856,0.001277727078935165
sample,0.32,0.65,0.15,1.6072451846755507,Eu,1.408,0.9916691552025819,1.0060868975663129,0.0012424827628379378
sample,0.32,0.65,0.15,1.6072451846755507,Rb,1.0772,0.9904570361456753,1.0069783618122916,0.0014244521400531777
sample,0.32,0.65,0.15,1.6072451846755507,Ba,0.49626,0.9864127435157788,1.0099860277419668,0.0020383893770913233
sample,0.32,0.65,0.15,1.6072451846755507,Cs,0.7962,0.9889976773614517,1.008058237639926,0.0016448808703256883
QC,0.3,0.65,0.15,1.5067923606333287,Mg,0.843,0.9922680749126975,1.0048098707806588,0.0009818107617780114
QC,0.3,0.65,0.15,1.5067923606333287,Al,1.7788,0.9946525318893829,1.0033256500268342,0.0006788454690680729
QC,0.3,0.65,0.15,1.5067923606333287,Ca,3.0845,0.9959725451656821,1.0025298018729412,0.0005163936449202541
QC,0.3,0.65,0.15,1.5067923606333287,Cl,1.64259,0.9944361070021313,1.003458182479617,0.000705898542707848
QC,0.3,0.65,0.15,1.5067923606333287,Mn,1.8107,0.9947032270754269,1.0032946118847823,0.000672509834852151
QC,0.3,0.65,0.15,1.5067923606333287,Na,1.36855,0.9939122853683504,1.0037816203785637,0.0007719200273659617
QC,0.3,0.65,0.15,1.5067923606333287,Ti,0.32,0.9882587475161448,1.0073664825720536,0.0015036769583863685
QC,0.3,0.65,0.15,1.5067923606333287,V,1.434,0.9940603119356215,1.003689659042879,0.0007531484983249404
QC,0.3,0.65,0.15,1.5067923606333287,Sc,0.8896000000000001,0.9924540217496061,1.004693188662541,0.0009579931241533697
QC,0.3,0.65,0.15,1.5067923606333287,Tb,0.8797999999999999,0.9924149131873384,1.0047177266768579,0.0009630019253514957
QC,0.3,0.65,0.15,1.5067923606333287,Sr,0.5145,0.9903643413664722,1.006010578328624,0.0012269041636799355
QC,0.3,0.65,0.15,1.5067923606333287,Co,1.3326,0.9938309907036821,1.003832133255744,0.0007822309252436136
QC,0.3,0.65,0.15,1.5067923606333287,Eu,1.408,0.9940015048875621,1.0037261904174168,0.0007606054339266269
QC,0.3,0.65,0.15,1.5067923606333287,Rb,1.0772,0.9931261004191065,1.0042720690580307,0.0008720324448422956
QC,0.3,0.65,0.15,1.5067923606333287,Ba,0.49626,0.990221612848735,1.0061011349484097,0.001245388956288793
QC,0.3,0.65,0.15,1.5067923606333287,Cs,0.7962,0.9920756238637968,1.004930704564756,0.0010064758546719959
"""


def get_df_mass():
    with StringIO(s_mass) as f:
        df_mass = pd.read_csv(f, index_col=list(range(0, 6)))

    return df_mass


def get_df_gamma():
    with StringIO(s_gamma) as f:
        df_mass = pd.read_csv(f, index_col=0)

    return df_mass


def get_df_shielding_ratio():
    with StringIO(s_shielding_ratio) as f:
        df_ratio = pd.read_csv(f, index_col=list(range(0, 5)), header=[0, 1])
    return df_ratio


def get_df_atten_ratio():
    with StringIO(s_atten_ratio) as f:
        df_ratio = pd.read_csv(f, index_col=list(range(0, 7)), header=[0, 1])
    return df_ratio


import neutron_analysis.photonatten as photonatten
import neutron_analysis.shielding as shielding


def test_shielding():

    df_mass = get_df_mass()
    df_ratio = get_df_shielding_ratio()

    S = shielding.NeutronShieldingUser(df_mass)
    S0 = shielding.NeutronShieldingUser(df_mass)

    for s in [S, S0]:
        pd.testing.assert_frame_equal(
            s.shielding_ratio("std", value_name="values"), df_ratio
        )


def test_atten():
    df_mass = get_df_mass()
    df_gamma = get_df_gamma()

    df_ratio = get_df_atten_ratio()

    p = photonatten.PhotonAtten(df_gamma, df_mass)

    pd.testing.assert_frame_equal(p.atten_ratio(value_name="values"), df_ratio)
